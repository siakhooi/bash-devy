#!/bin/bash

usage() {
  echo "Usage: $(basename "$0") [-h] [-a] [-n] [-e] [-r] [-A repo_root [repo_path]]"
  echo "     : do git commit with message from git-commit.yaml"
  echo " -a  : do git commit --amend"
  echo " -n  : do git commit --amend --no-edit"
  echo " -e  : edit git-commit.yaml"
  echo " -r  : git push for review"
  echo " -A repo_root [repo_path]: auto commit, repo_path default to ."
}
action=commit
message=Y
options=()
while getopts "heranA" arg; do
  case $arg in
  h)
    usage
    exit 0
    ;;
  e)
    action=edit
    ;;
  r)
    action=review
    ;;
  a)
    options+=(--amend)
    ;;
  n)
    message=N
    options+=(--amend --no-edit)
    ;;
  A)
    action=autocommit
    ;;
  *)
    usage
    exit 1
    ;;
  esac
done
shift $((OPTIND - 1))

readonly config1=./.git-commit.yaml
readonly config2=../.git-commit.yaml

git_commit_config=$config1
if [[ ! -f "$config1" ]] && [[ -f "$config2" ]]; then
  git_commit_config=$config2
fi

if [[ "$action" == "edit" ]]; then
  if [[ ! -f "$git_commit_config" ]]; then
    echo "message: <message>" >"$git_commit_config"
  fi
  $EDITOR "$git_commit_config"
  exit $?
fi

if [[ $action == "commit" ]]; then
  set -e
  if [[ $message == "Y" ]]; then
    if [[ ! -f "$git_commit_config" ]]; then
      echo.error "config file $git_commit_config not found"
      exit 1
    fi
    message=$(yq .message "$git_commit_config")
    if [[ -z $message ]]; then
      echo.error "message not found in $git_commit_config"
      exit 2
    fi
    options+=(-m "$message")
  fi
  (
    set -x
    git commit "${options[@]}"
  )
fi

if [[ $action == "review" ]]; then
  set -e
  git_branch=$(git-get -b)
  (
    set -x
    git push origin "HEAD:refs/for/$git_branch"
  )

fi

if [[ $action == "autocommit" ]]; then
  if [[ $# -ne 1 ]] && [[ $# -ne 2 ]]; then
    echo.error "Usage: $(basename "$0") -A repo_root [repo_path]"
    exit 1
  fi
  repo_root=$1
  repo_path=${2:-.}
  if [[ ! -d "$repo_root" ]]; then
    echo.error "repo_root $repo_root not found"
    exit 1
  fi
  set -e
  (
    cd "$repo_root" || {
      echo.error "not able to enter repo_root $repo_root"
      exit 1
    }
    git add "$repo_path"
    git commit -m "Auto Commit- $(y2s)"
  )
fi
