#!/bin/bash

usage() {
	echo "Usage: $(basename "$0") [-h] [-V] [-f binary-list-file] binary..."
	echo "  -h                      Show this help message and exit"
	echo "  -V                      show binary version whenever possible"
	echo "  -f binary-list-file     Specify a file containing a list of binaries to check (one per line)"
	echo "  binary...               List of binaries to check"
}
binaries=()
show_version=false
while getopts "hVf:" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	f)
		if [[ ! -f $OPTARG ]]; then
			echo.error "File not found: $OPTARG"
		fi
		mapfile -t temp_array <"$OPTARG"
		binaries+=("${temp_array[@]}")
		;;
	V)
		show_version=true
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))
binaries+=("$@")

if [[ ${#binaries[@]} -eq 0 ]]; then
	usage
	exit 0
fi

found=()
not_found=()

for bin in "${binaries[@]}"; do
	if command -v "$bin" >/dev/null 2>&1; then
		if $show_version && [[ "$bin" == "jq" ]]; then
			version=$("$bin" --version | cut -d'-' -f2)
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "yq" ]]; then
			version=$("$bin" --version | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "npm" || "$bin" == "yarn" || "$bin" == "firebase" ]]; then
			version=$("$bin" --version)
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "groovy" ]]; then
			version=$("$bin" --version | awk '/Groovy Version:/ {print $3}')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "git" || "$bin" == "podman" ]]; then # third word
			version=$("$bin" --version | cut -d' ' -f3)
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "python" ]]; then # second word
			version=$("$bin" --version | awk '{print $2}')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "gh" ]]; then # third word of line 1
			version=$("$bin" --version | awk 'NR==1 {print $3}')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "node" ]]; then # remove Leading 'v'
			version=$("$bin" --version | cut -c2-)
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "spring" ]]; then
			version=$("$bin" --version | cut -d'v' -f2)
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "go" ]]; then
			version=$("$bin" version | grep -oP 'go\K[0-9]+\.[0-9]+\.[0-9]+')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "docker" ]]; then
			version=$("$bin" --version | grep -oP '[0-9]+\.[0-9]+\.[0-9]+')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "java" ]]; then
			version=$("$bin" -version 2>&1 | awk -F'"' '/version/ {print $2}')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "helm" ]]; then
			version=$("$bin" version | grep -oP 'Version:"v\K[0-9]+\.[0-9]+\.[0-9]+')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "mvn" ]]; then
			version=$("$bin" --version | grep -oP 'Apache Maven \K[^ ]+')
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "gradle" ]]; then
			version=$("$bin" -v | awk '/^Gradle/ {print $2}')
			found+=("$bin=$version")
		else
			found+=("$bin")
		fi
	else
		not_found+=("$bin")
	fi
done

# sort
mapfile -t found < <(printf "%s\n" "${found[@]}" | sort)
mapfile -t not_found < <(printf "%s\n" "${not_found[@]}" | sort)

[[ ${#found[@]} -gt 0 ]] && echo.green -n "${found[@]}"
[[ ${#found[@]} -gt 0 && ${#not_found[@]} -gt 0 ]] && echo -n ' '
[[ ${#not_found[@]} -gt 0 ]] && echo.red "${not_found[@]}"

exit $((${#not_found[@]} > 0))
