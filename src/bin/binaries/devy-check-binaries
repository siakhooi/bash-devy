#!/bin/bash

usage() {
	echo "Usage: $(basename "$0") [-h] [-V] [-f binary-list-file] binary..."
	echo "  -h                      Show this help message and exit"
	echo "  -V                      show binary version whenever possible"
	echo "  -f binary-list-file     Specify a file containing a list of binaries to check (one per line)"
	echo "  binary...               List of binaries to check"
}
binaries=()
show_version=false
while getopts "hVf:" arg; do
	case $arg in
	h)
		usage
		exit 0
		;;
	f)
		if [[ ! -f $OPTARG ]]; then
			echo.error "File not found: $OPTARG"
		fi
		mapfile -t temp_array <"$OPTARG"
		binaries+=("${temp_array[@]}")
		;;
	V)
		show_version=true
		;;
	*)
		usage
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))
binaries+=("$@")

if [[ ${#binaries[@]} -eq 0 ]]; then
	usage
	exit 0
fi

found=()
not_found=()

for bin in "${binaries[@]}"; do
	if command -v "$bin" >/dev/null 2>&1; then
		if $show_version && [[ "$bin" == "jq" ]]; then
			version=$("$bin" --version | cut -d'-' -f2)
			found+=("$bin=$version")
		elif $show_version && [[ "$bin" == "yq" ]]; then
			version=$("$bin" --version | grep -oP 'v\K[0-9]+\.[0-9]+\.[0-9]+')
			found+=("$bin=W$version")
		else
			found+=("$bin")
		fi
	else
		not_found+=("$bin")
	fi
done

# sort
mapfile -t found < <(printf "%s\n" "${found[@]}" | sort)
mapfile -t not_found < <(printf "%s\n" "${not_found[@]}" | sort)

[[ ${#found[@]} -gt 0 ]] && echo.green -n "${found[@]}"
[[ ${#found[@]} -gt 0 && ${#not_found[@]} -gt 0 ]] && echo -n ' '
[[ ${#not_found[@]} -gt 0 ]] && echo.red "${not_found[@]}"

exit $((${#not_found[@]} > 0))
